\chapter{Push Notifications}
Johannes Franz \& Normen Krug

\section{Einleitung}
Push Notifications sind ein fester Bestandteil moderner Apps. Nutzer erwarten es häufig bei Änderungen oder Neuigkeiten informiert zu werden. Deswegen soll die Stundenplan App um solche erweitert werden. Ziel soll es sein den Benutzer über Stundenplanänderungen aktiv zu informieren, um speziell auf kurzfristige Änderungen reagieren zu können. Ein Server überprüft dabei eine Stundenplan Datenbank auf Änderungen und sendet eine Push Notification an alle iOS Geräte, die sich für die jeweilige Vorlesung registriert haben. Ein Apache Webserver stellt dabei mit einer MySQL Datenbank und entsprechenden Cronjobs das Backend bereit.

GitHub repository: \url{https://github.com/HochschuleHofStundenplanapp/iOS-App/}


\section{Istzustand}
Die iOS Version stellt nur lokale Push Notifications bereit. Dabei wird bisher keine Serverkomponente benötigt.

\newpage

\section{Projektablauf}
Um den Projektfortschritt nachvollziehen zu können, wurde dieser tabellarisch in Verbindung mit dem aktuellen Meilenstein aufgelistet.


\noindent%
\begin{tabularx}{\textwidth}{|p{.25\textwidth}|X| }
\hline
\textbf{Meilenstein} & \textbf{Details}  \\ \hline 

Vorlesungsbeginn & Themenfindung \\ \hline

Siri & Einarbeitung in Siri. Erkennen erster Hürden. Abbruch des Themas und dokumentieren der Erkenntnisse \\ \hline

Neue Themenfindung & Verwerfen von der Siri Projektidee und neue Themenfindung. \\ \hline

Festlegung & Thema Push Notifications festgelegt und Beginn der Einarbeitung. \\ \hline

Erfolgreiche Tests & Push Notifications lassen sich per PHP Script an einen fest eingestellten Token schicken \\ \hline

Neue Push Variante & Eine Test iOS App kann per php Script mittels MAMP lokal eine Push Notification senden. \newline
Datenbank lokal in PhpMyAdmin angelegt. \newline
PHP Script schreibt bei Aufruf in die angelegte SQL Datenbank. \newline
Einarbeitung und Konvertierung der Dokumentation in Latex.
 \\ \hline
 Register Script & Die Test iOS App wurde so erweitert, dass ein JSON File per POST Nachricht übermittelt werden kann.\newline
Das PHP Script parst nun das ankommende JSON File und fügt per insert die geparsten Daten in die Datenbank ein.\newline 
Einarbeitung in bestehende Schnittstelle und Überlegungen wie das bestehende Backend erweitert werden muss. 
 \\ \hline
 
 \
 

Abwärtskompatibilität & PHP Scripte der bestehenden (Android) Schnittstelle angepasst und getestet. \newline
\\ \hline 
 
 
Testserver & Testserver wurde bereitgestellt. \newline
\\ \hline 
 
 
PN mit HTTP2 & Push Notifications mit HTTP2 implementiert.\newline
\\ \hline 

Feinschliff & Finale Anpassung der Implementation und Dokumentation.
\\ \hline  

\end{tabularx}

\newpage


\section{Erster Ansatz der Umsetzung}

\subsection{MAMP als Virtuelle Umgebung}

\subsubsection{MAMP}
Die Testumgebung MAMP (Akronym steht für: Mac, Apache, MySQL, PHP) virtualisiert die genannten Komponenten, um lokale Tests zu ermöglichen.

\subsection{Hilfstools}
Die MacOS App ``Easy APNs Provider`` ermöglichte ersten Gehversuche, um Push Nachrichten an ausgewählte Token zu senden.
Zu beachten is,t dass der ``Easy APNs Provider`` das veraltete Push Interface benutzt. 
\\
Quelle: Mac App Store: ''easy apns provider push
 notification service testing tool''

\section{Vorbereitung der Umsetzung}
Apple bietet für die Umsetzung von Push Nachrichten den Apple Push Notification service (APNs) an. Dabei handelt es sich um einen bei Apple gehosteten Dienst, der Push Notifications per API ermöglicht. Nur diesem Dienst ist es erlaubt, die Push Notification direkt an das iOS Gerät zu senden.


\subsection{Server Installation}
Zur Installation der Software sind ROOT Rechte notwendig. Der \textit{wget} Befehl läd dabei eine zum aktuellen Zeitpunkt sehr neue \textit{curl} Version herunter. Diese hat die Besonderheit HTTP2 zu unterstützen, welches für die Push Notification Schnittstelle von Apple vorausgesetzt ist.

\newpage

\subsection{MySQL Datenbank}

Die Tabelle \textit{fcm\_nutzer} enthält eine Zuordnung von abonnierten Vorlesungsverlegungen mit dem jeweiligen Token des Gerätes. Dabei ist zusätzlich vermerkt, welches Betriebssystem verwendet wird. Die \textit{0} in der Spalte \textit{os} steht dabei für Android während \textit{1} iOS repräsentiert. \\
Da die ausgewählte Sprache des Nutzers nicht bekannt ist, wird für die \textit{language} Spalte an dieser Stelle auch null akzeptiert. Um bei einer späteren Version der App zwischen Nutzern die noch keine Sprache ausgewählt haben und allen Anderen differenzieren zu können, wird hier trotz der aktuell nur in deutsch vorhandenen App der Wert nicht standardmäßig auf deutsch gesetzt.
\lstinputlisting[language=SQL]{content/pushNotifications_create.sql}
Da eine bestehende Infrastruktur die Grundlage dieses Projektes darstellt, musste diese Tabelle lediglich um \textit{os} und \textit{language} erweitert werden.\\
Auf Änderungen an anderen Tabellen konnte komplett verzichtet werden.

\newpage

\subsubsection{fcm\_nutzer Tabelle}
Diese Tabelle beinhaltet vor allem die Verknüpfung zwischen dem eingetragenen Token (\textit{token}), der abonnierten Vorlesung (\textit{vorlesung\_id}) und dem mobilen Betriebsystem (\textit{os}). Diese Tabelle wurde beim Testsystem und beim Produktivsystem bereits um die neue Spalte \textit{os} und \textit{language} erweitert. Für letztere wurde die Schnittstelle, iOS und Android Version angepasst und getestet. Diese Funktion kann für zukünftige Implementierungen verwendet werden.
\begin{figure}[H]
	\centering
  \frame{ \includegraphics[width=1.0\textwidth]{datenbank_nutzer} }
	\caption{Tabelle fcm\_nutzer in phpmyadmin}
	\label{datenbank_nutzer}
\end{figure}

\textcolor{black}{
\lstinputlisting[language=bash]{content/pushNotifications_server_install.bsh}
}

\newpage

\subsection{Zertifikate}
Um mit einer gesicherten Verbindung auf die Apple Push Notification Schnittstelle zuzugreifen, werden zwei Zertifikate benötigt. Dabei handelt es sich um ein öffentliches und privates Zertifikat. Diese Zertifikate müssen vor der Verwendung in das Zielformat \textit{.pem} umgewandelt werden, bevor sie benutzbar sind.

Um die Zertifikate anzulegen und zu verwalten, stellt Apple eine Übersicht dem bei Apple angemeldeten Entwickler bereit. Bei dem verwendeten Zertifikat wird zwischen \textit{Development} und \textit{Production} unterschieden.\\
\url{https://developer.apple.com/account/ios/certificate/}


\subsection{CURL}
Der Server verwendet CURL um die Push Notificiation an den Service von Apple zu senden.  
CURL verwendet dabei das HTTP2 Protokoll.

\textcolor{black}{
\lstinputlisting[language=bash]{content/pushNotifications_curl_example.bsh}
}


\subsection{Sicherheit}
Das Thema Sicherheit spielt in der IT eine Zentrale, aber oft vernachlässigte Rolle. So ist beim der Einrichtung auf dem Server auf einige Punkte zu achten. Die hier verwendeten Software Versionen wie Apache2, MySQL oder CURL können auf dem Server auf die in der Zukunft aktuelle Version geupdatet werden.
Die Dateirechte der PHP Dateien sowie Zertifikate müssen entsprechend angepasst werden und nur gewissen Usern angehören.\\
Da das Projekt öffentlich auf GitHub für jeden einsehbar ist, müssen die Passwörter so gewählt werden, dass sie keinem vorher verwendeten Passwort gleichen. Dies war bisher im Umgang mit dem Testsystem absichtlich nicht der Fall, was praktische Vorteile mit sich gebracht hat.

\newpage

\subsection{Builden der App}
Bevor die App verwendet werden kann, muss speziell im Fall der Push Notifications auf gewisse Details geachtet werden.


In der \textit{Info.plist} stehen drei neue Parameter für Push Notifications bereit. Diese ermöglichen das Hin- und Herschalten zwischen dem Test- und Produktivserver mittels des \textit{isPushTesting} Parameters. Die beiden anderen Parameter repräsentieren sprechend den jeweiligen Link.\\
Bei dieser Einstellung ist darauf zu achten, dass sie sich nur auf die Anmeldung am jeweiligen Server bezieht. Informationen wie Stundenpläne und Änderungen kommen unabhängig von dieser Einstellung weiterhin vom Produktivserver (\textit{ https://app.hof-university.de/soap/}).

\begin{figure}[H]
	\centering
  \frame{ \includegraphics[width=1.0\textwidth]{plist} }
	\caption{Anpassungen in der Info.plist}
	\label{plist}
\end{figure}


Das Developer Team muss wie folgt ausgewählt werden, damit Push Notifications zur Verfügung stehen:
\begin{figure}[H]
	\centering
  \frame{ \includegraphics[width=1.0\textwidth]{devteam} }
	\caption{Wahl des Developer Teams}
	\label{devteam}
\end{figure}


Capabilities müssen wie folgt angepasst werden:

\begin{figure}[H]
	\centering
  \frame{ \includegraphics[width=1.0\textwidth]{capabilities} }
	\caption{Angepasste Capabilities}
	\label{capabilities}
\end{figure}

\newpage

\section{Implementierung}
Da die App bisher keine Push Notifications aus externen Quellen verwendet hat, musste dies komplett neu implementiert werden. Dabei mussten Änderungen am Server und  an der App vorgenommen werden, die gut aufeinander abgestimmt werden mussten.

\subsection{Senden der Volesungsdaten zum Server}
Damit der User für alle seine Vorlesungen über Änderungen informiert werden kann, müssen alle Vorlesungen gebündelt mit ihrem Device Token zum Server gelangen. 

\subsubsection{Extrahieren der Vorlesungs IDs}
Um an die Splusnamen der Vorlesungen zukommen, werden alle Vorlesungen aus den Model geladen. Die Splusnamen werden in ein \textit{JSONArray} gepackt und zusammen mit den Parametern Devicetoken, OS und Sprache in ein \textit{JSONObject} umgewandelt.
\lstinputlisting[language=swift]{content/lectures.swift}

\newpage

\subsubsection{POST Anfrage}
Die Daten werden per \textit{HTTP POST Request} an den Hochschule Server übermittelt. Alle benötigten Metatdaten werden der URLRequest Klasse übergeben. Zusätzlich wird der JSONPayload in den Body der Anfrage geschrieben. 
\lstinputlisting[language=swift]{content/PostRequest.swift}

\subsection{Server-Schnittstelle}
Da sich die Registrierung am Server von der bestehenden Android Schnittstelle unterschieden hat, mussten am Server verschiedene PHP Scripte angepasst werden.

Eine wichtige Anforderung an diese Implementierung war die Abwärtskompatibilität an noch nicht geupdatete Versionen der Android Stundenplan App. Auch die unkomplizierte Weiterverwendung von bestehenden Prozessen und Scripten war von Bedeutung.

\newpage


\subsection{Registerung für Push Notifications}
Die App registriert sich, sobald eine Vorlesung ausgewählt und übernommen wird am Server. Dafür ist das Script \textit{fcm\_register\_user.php} zuständig. Es erkennt anhand eines PHP Parameters ( \textit{...php?os=1 }), dass es sich um einen Aufruf durch eine iOS Anwendung handelt und stellt die passenden Abzweigungen und Funktionen bereit, die sich von der Android Variante unterscheiden.

Die dafür notwendigen Änderungen an der Datenbank wurden bereits im gleichnamigen Kapitel beschrieben. Diese Änderungen sind bereits auf dem Test- und Produktivsystem umgesetzt worden.

Durch die genannte Abwärtskompatibilität und Aufrufe des Scriptes durch interessierte Benutzer ist die Gefahr gegeben, dass \textit{Null} Werte in die Datenbank geschrieben werden. Das Script wurde dementsprechend erweitert, um möglichst an keiner Stelle diesen Fehlerfall zu ermöglichen.

\subsection{Senden der Nachrichten durch den Server}
Auf dem Server läuft ein Cronjob, der in einer definierten Zeit die Verlegungen prüft. Wurde eine Stundenplanänderung neu hinzugefügt, die noch nicht in der Tabelle \textit{fcm\_verlegungen} aufgelistet war, so reagiert das Script \textit{fcm\_update\_and\_send.php} und schreibt die Vorlesung in die genannte Tabelle.\\
Die Methode \textit{sendNotification()} prüft nun vor dem Senden um welche Übertragungsart (Firebase / APNs) es sich handelt und ruft die passende Methode auf.
Um der Übersichtlichkeit beizutragen, ist die APNs Funktionalität in der eingebundenen PHP Datei \textit{apnsPushIOS.php} abgebildet. Die darin enthaltene \textit{sendIosPush(...)} Methode die hier aufgerufen wird, benötigt lediglich \textit{title, body} und \textit{token} als Parameter. Der \textit{title} stellt dabei die Überschrift dar, während der \textit{body} den Nachrichteninhalt bereitstellt.

\newpage

\subsection{Reagieren auf Benachrichtigungen in der App}
Damit der Benutzer nicht jede Benachrichtigung einzeln bestätigen muss, wurde die \textit{didReceiveRemoteNotification()} Methode implementiert. Diese Funktion wird vom System aufgerufen wenn eine Benachrichtigung eintrifft. Die App kann beim Eintreffen der Benachrichtigung in zwei von drei verschieden Zuständen sein. Falls sie aktuell geöffnet oder inaktiv ist, kann der Benutzer mit einem Klick auf die Benachrichtigung schnell zu den Änderungen gelangen. 
Dabei werden alle weiteren Benachrichtigungen für die App ausgeblendet.
\\

\lstinputlisting[language=swift]{content/didRecivePush.swift}

\newpage

\section{Aufgetretene Probleme}
Als Herausforderung zu sehende Punkte haben häufig sehr viel Zeit in Anspruch genommen oder den Projektfortschritt entschleunigt.


\begin{itemize}
\item Verzögerte Bereitstellung des Servers führte zu komplexen Reimplementierungen in schwer zu synchronisierenden getrennten VMs
\item Beschränkte Rechte auf dem Testserver die nach und nach erweitert werden mussten
\item Verschiedene Zertifikatarten sind sehr verwirrend
\item Bundle Identifier und App Capabilities mussten nach jedem Git Pull wieder angepasst werden
\item Komplexes Testen (Lokale Server, Erreichbarkeit im Labornetzwerk / Wi-Fi, unterschiedliche Datei- und Serverstände) 
\item Zu Beginn kein Zugriff auf die Git Schnittstellen Projekt
\item Ablaufende Zertifikate
\item Serverseitig unterschiedliche Übertragungsverfahren zwischen Android und iOS
\item Erschwertes Debugging der PHP Scripte
\item Die auf den Server vorhanden Versionen von Apache2 und CURL, hatten kein HTTP2 unterstützt  
\item Struktur der Datenbank und der PHP Scripte war durch die Android App vorgegeben
\item Veraltete APNs Variante war stark verbreitet, brachte allerdings viele Probleme mit sich und musste als Ansatz letztendlich verworfen werden
\end{itemize}

\newpage

\section{Fazit}
Unser Team hat feststellen müssen, dass zu einem umfassenden iOS Projekt mehr als nur der Interface Builder und die Sprache Swift gehört. So sind Punkte zu nennen die positiv aus dem Projekt mitgenommen wurden.
\begin{itemize}
\item Linuxkenntnisse und der Umgang mit einem Produktiv- und Testsystem
\item PHP und Debugging auf dem Server
\item Beachten von Abhängigkeiten wie der Abwärtskompatibilität der Software zu früheren und bestehenden Android Versionen
\end{itemize}

\section{Weitere Arbeiten}
In diesem Projektabschnitt konnten alle gesteckten Ziele erreicht werden. Da solch ein relativ junges Projekt noch viele Möglichkeiten beinhaltet Funktionen zu verbessern und neue Funktionen einzuführen werden hier mögliche Punkte zur Anregung aufgelistet.

\begin{itemize}
\item Die Auswertung des Kommentarfeldes welche, aktuell bei der Android und iOS App auf dem Client Gerät stattfinden, könnten auf dem Server zentral bearbeitet werden. Das würde die Komplexität der beiden Apps verringern und erleichtert die Wartung des Codes an zentraler Stelle.
\item Erweiterung der Push Notification Information um eine Priorität, Ablaufdatum, etc.
\item Erweiterung der App und Schnittstelle um andere Sprachen wie z.B. Englisch was in der Android App bereits angeboten wird
\item Aufkommende Issues und Ideen aus dem öffentlichen Git Projekt der iOS App und Schnittstelle

\end{itemize}

